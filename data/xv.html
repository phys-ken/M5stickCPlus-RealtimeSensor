<!--//マイコン用、リアルタイムプロットシステム
//2020/1/26(日)作成
//tetro_y　に測定値を連続して代入することで、プロットできるはず。
//測定値がフィールドの高さからはみ出すと、動作は一時停止。
//測定値を、FIELD_ROW段階に丸める必要あり。-->


<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
</head>

<body onload="draw()" link="white" vlink="white"><font size="6">
  <p>位置　 <span id="RealtimeArea1">mojimoji</span> cm </p>
  <p>速度　 <span id="RealtimeArea2">mojimoji</span> cm/s </p></font>
  <p>2020/2/16(Sun)</p>
  <p>長倉作成</p>



  <script>
var Anime_SPEED = 100;
    var x1 = 0;
    var x2 = 0;
    var v = 0;
    //配列の個数（速度の平均回数）
    var vstp = 8;
    //配列vvv定義と初期化
    let vvv = [];
    for (var i = 0; i < vstp; i++) {
      vvv[i] = 0;
    }
    var vplot = 0;
var plotvalue1 = 0;
var plotvalue2 = 0;

    function draw() {
      setInterval(move, Anime_SPEED);
    }

    function move() {
      x1 = x2;//過去の値をv1に代入
      if (1 * reqest() > 50) {
        x2 = x2;//測定値が50センチ以上のときは、全快の値を採用
      } else {
        x2 = 1 * reqest();//そうじゃなければ、測定値を更新
      }
      var v0 = vplot;
      v = (x2 - x1) / (Anime_SPEED / 1000);//速度を計算
      //配列を1ステップ進める
      for (var i = 0; i < vstp; i++) {
        vvv[i + 1] = vvv[i];
      }
      //最新の値を配列に代入
      vvv[0] = v;
      //合計を計算し、平均を算出
      var sum = 0;
      for (var i = 0; i < vstp; i++) {
        sum = sum + vvv[i];
      }
      vplot = sum / vstp;

      var a = ( v0 - vplot )  / (Anime_SPEED / 1000);

      //////////////////////////////////////////////////////////////graph用///////////////////////////////////////////////
      plotvalue1 = -1 * Math.floor( 1 * reqest()); //整数に丸める
      plotvalue1 = Math.floor(plotvalue1); //整数に丸める
      plotvalue1 = -(plotvalue1); //0点合わせ　(必要に応じて)
      document.getElementById("RealtimeArea1").innerHTML = plotvalue1; //数値を表示
      //正負で色分けする
      if (plotvalue1 >= 0) {
        document.getElementById("RealtimeArea1").style.color = "#3300FF";
      } else {
        document.getElementById("RealtimeArea1").style.color = "#FF3300";
      }



      plotvalue2 = -1 * Math.floor(vplot); //整数に丸める
      plotvalue2 = Math.floor(plotvalue2); //整数に丸める
      plotvalue2 = -(plotvalue2); //0点合わせ　(必要に応じて)
      document.getElementById("RealtimeArea2").innerHTML = plotvalue2; //数値を表示
      //正負で色分けする
      if (plotvalue2 >= 0) {
        document.getElementById("RealtimeArea2").style.color = "#3300FF";
      } else {
        document.getElementById("RealtimeArea2").style.color = "#FF3300";
      }
      /////////////////////////////////////////////////////graph用　終わり//////////////////////////////////////////
    }

    ////////////////////////////////////////////////////////////////////リクエストをマイコンに送る
    function reqest() {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          y = parseFloat(this.responseText);
          //console.log(this.responseText);
        }
      };
      xhttp.open("GET", "/temperature", true);
      xhttp.send();
      return y;
    }
    ////////////////////////////////////////////////////////////////リクエスト関数終わり




  </script>



</body>

</html>
